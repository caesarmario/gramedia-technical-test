####
## Gramedia Digital - Data Engineer Take Home Test
## by Mario Caesar // caesarmario87@gmail.com
## DAG Orchestrator to extract data from FakeStore API (with TaskGroup)
####

from airflow import DAG
from datetime import datetime, timedelta

# Use non-deprecated providers
from airflow.providers.standard.operators.empty import EmptyOperator
from airflow.providers.standard.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.utils.task_group import TaskGroup

default_args = {"owner": "data-eng", "retries": 0}

with DAG(
    dag_id          = "00_dag_{{ project }}_orchestrator",
    schedule        = "0 * * * *",
    start_date      = datetime(2025, 1, 1),
    catchup         = False,
    max_active_runs = 1,
    default_args    = default_args,
    tags            = ["{{ project }}", "orchestrator", "extract"],
) as dag:

    t00_start = EmptyOperator(task_id="t00_start")

    # Group all extract triggers so they run in parallel but are visually grouped
    with TaskGroup(group_id="tg_extract_all", tooltip="Trigger per-resource extract DAGs") as tg_extract_all:

        {% for r in resources %}
        {% set dag_num   = "%02d"|format(r.order) %}
        {% set target_id = "00_" ~ dag_num ~ "_dag_" ~ project ~ "_extract_" ~ r.name %}

        TriggerDagRunOperator(
            task_id             = "t10_trigger_extract_{{ r.name }}",
            trigger_dag_id      = "{{ target_id }}",
            conf                = {"ds": "{{ ds }}"},
            wait_for_completion = True,
            reset_dag_run       = True,
            poke_interval       = 30,
            allowed_states      = ["success"],
            failed_states       = ["failed"],
        )
        {% endfor %}

    t20_trigger_transform_orchestrator = TriggerDagRunOperator(
        task_id             = "t20_trigger_01_dag_{{ project }}_orchestrator",
        trigger_dag_id      = "01_dag_{{ project }}_transform_orchestrator",
        conf                = {"ds": "{{ ds }}"},
        wait_for_completion = False,   # fire-and-continue; set True if you want to wait
        reset_dag_run       = True,
        poke_interval       = 30,
        allowed_states      = ["success"],
        failed_states       = ["failed"],
    )

    t90_finish = EmptyOperator(task_id="t90_finish")

    # Flow: start → [all extracts in group] → trigger next orchestrator → finish
    t00_start >> tg_extract_all >> t20_trigger_transform_orchestrator >> t90_finish
