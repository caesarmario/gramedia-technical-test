####
## Gramedia Digital - Data Engineer Take Home Test
## by Mario Caesar // caesarmario87@gmail.com
## DAG Orchestrator: trigger per-resource transform DAGs
####

from __future__ import annotations

from datetime import datetime, timedelta
from airflow import DAG
from airflow.providers.standard.operators.empty import EmptyOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator

default_args = {"owner": "data-eng", "retries": 0}

with DAG(
    dag_id="01_dag_{{ project }}_transform_orchestrator",
    schedule="0 * * * *",     # hourly (adjust to your cadence)
    start_date=datetime(2025, 1, 1),
    catchup=False,
    max_active_runs=1,
    default_args=default_args,
    tags=["{{ project }}","orchestrator","transform","parquet"],
) as dag:

    t00_start = EmptyOperator(task_id="t00_start")

    triggers = []
    {% for r in resources %}
    t_trigger_{{ r.name }} = TriggerDagRunOperator(
        task_id="t10_trigger_transform_{{ r.name }}",
        trigger_dag_id="01_{{ '%02d'|format(r.order) }}_dag_{{ project }}_transform_{{ r.name }}",
        conf={"ds": "{{ ds }}"},
        wait_for_completion=True,
        reset_dag_run=True,
        poke_interval=30,
        allowed_states=["success"],
        failed_states=["failed"],
    )
    triggers.append(t_trigger_{{ r.name }})
    {% endfor %}

    t90_finish = EmptyOperator(task_id="t90_finish")

    t00_start >> triggers >> t90_finish
